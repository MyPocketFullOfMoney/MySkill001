# 目录
<!-- TOC -->

- [目录](#目录)
  - [前言](#前言)
  - [MySQL常用指令](#mysql常用指令)
  - [MySQL常用函数](#mysql常用函数)
  - [MySQL存储引擎](#mysql存储引擎)
    - [InnoDB](#innodb)
    - [MyISAM](#myisam)
  - [索引](#索引)
    - [索引的定义](#索引的定义)
    - [MySQL索引原理](#mysql索引原理)
    - [索引的作用](#索引的作用)
    - [建立索引的原则](#建立索引的原则)
    - [索引失效的情况](#索引失效的情况)
    - [聚簇索引和非聚簇索引](#聚簇索引和非聚簇索引)
    - [创建索引的语法](#创建索引的语法)
  - [主键和外键](#主键和外键)
  - [事务的基本概念](#事务的基本概念)
  - [并发控制概述](#并发控制概述)
  - [封锁](#封锁)
    - [封锁协议](#封锁协议)
  - [MySQL实现事务的原理](#mysql实现事务的原理)
  - [MySQL的隔离级别](#mysql的隔离级别)
  - [参考资料](#参考资料)

<!-- /TOC -->

## 前言

该模块中主要记录数据库模块相关的知识。

## MySQL常用指令  

- 显示表结构  
    `desc [tablename]`  
- 查看建表语句  
    `show create table [tablename]`

## MySQL常用函数

- concat
- sum
- date_format
- sysdate
- ifnull
- 开窗函数

## MySQL存储引擎

### InnoDB

支持事务。MySQL的默认存储引擎

### MyISAM  

不支持事务。索引文件和数据文件分开，在插入和查询数据时，能提供较高的效率。

## 索引

### 索引的定义

MySQL官方对索引的定义为：索引（Index）是帮助MySQL高效获取数据的**数据结构**。

索引的本质是数据结构，数据结构可以划分为逻辑结构和物理结构。

MySQL数据库选择B+ Tree作为索引的的结构。而Oracle数据库选择B-Tree作为索引的结构。

在MySQL中索引的物理结构（存储方式）与数据库选用的存储引擎有关系。

InnoDB:数据文件本身就是索引文件。数据都存放在叶子结点中。

MyISAM:索引文件和数据文件分离，B+ Tree的叶子结点存放的是指向数据的地址。

### MySQL索引原理

B+树的实现

### 索引的作用

提供数据的查询速度，类似如书本的目录。

但会增加额外的空间开销。

### 建立索引的原则

- 为频繁查询的字段建立索引，联合索引注意最左匹配原则
- 选择数据基数大的建立索引
- 频繁增删改的字段不要建立索引
- ‘大字段’不建立索引

### 索引失效的情况

- or中有一个没有索引
- like以%开头
- 条件中使用函数
- 索引字段使用了 not in 、not exist关键字

### 聚簇索引和非聚簇索引

根据数据与索引的存储关联性，划分为聚簇索引和非聚簇索引。

简单的理解就是索引的存储和数据的存储是否有关联，有关联就是聚簇索引，无关联则是非聚簇索引。

典型的例子：

- 当MySQL选择InnoDB为存储引擎时，主键索引就是典型的聚簇索引，主键索引构成的B+树中，非叶子结点存储索引的指针，叶子结点既存储索引也存储数据。

- 当MySQL选择MyISAM为存储引擎，索引和数据是分开存放的，所以里面的索引都可划分为非聚簇索引。

### 创建索引的语法

```SQL
create index index_name on table_name(column);
```

## 主键和外键

主键：表中经常有一列或多列的组合，其值能唯一的标识表中的每一行。不能为空，不能重复。

在创建表的过程中指定主键：

```SQL
create table test
(
  id int primary key,
  name varchar(24)
)
```

外键：外键就是另外一张表中的主键。外键可以为空，可以重复。

## 事务的基本概念

所谓**事务**是用户定义的一个数据库操作序列，这些操作要么全做，要么全不做，是一个不可分割的工作单位。

事务的特性：

- 原子性（Atomicity）
  >事务是数据库的逻辑工作单位，事务中包括的诸操作要么都做，要么都不做。
- 一致性（Consistency）
  >事务的执行结果必须是使数据库从一个一致性状态到另一个一致性状态。
- 隔离性（Isolation）
  >一个事务的执行不能被其他事务干扰。
- 持续性（Durability）
  >持续性也称永久性（Permanence）,指一个事务一旦提交，它对数据库中数据的改变就应该使永久的。

**事务是恢复和并发控制的基本单位。**

## 并发控制概述

上面提到**事务是并发控制的基本单位**，保证事务ACID特性是事务处理的重要任务，而事务的ACID特性可能遭到破坏的原因之一是多个事务对数据库的并发操作造成的。  

并发操作带来的数据不一致性包括**丢失修改、不可重复读和读“脏”数据**。  
产生上述数据不一致性的原因是因为并发操作破坏了事务的隔离性。

**并发控制的主要技术有封锁、时间戳、乐观控制法和多版本并发控制等。**

## 封锁

**封锁是实现并发控制的一个非常重要的技术。**  
基本的封锁类型有两种：排他锁（exclusive locks,简称X锁）和共享锁（share locks,简称S锁）。

**排他锁**又称为**写锁**。若事务T对数据对象A加上X锁，则只允许事务T读取和修改数据对象A，其他任何事务都不能再对A加任何类型的锁，直到T释放A上的锁为止。
>数据库中update操作对应的就是排他锁。

**共享锁**又称为**读锁**。若事务T对数据对象A加上S锁，则事务T可以读A但不能修改A，其他事务只能再对A加S锁，而不能加X锁，直到T释放A上的S锁为止。

### 封锁协议

在运用X锁和S锁这两种基本封锁对数据对象加锁时，还需要约定一些规则。  
例如，何时申请X锁或S、持锁时间、何时释放等。这些规则称为**封锁协议**。

- **一级封锁协议**
  >一级封锁协议是指，事务T在修改数据R之前必须先对其加X锁，直到事务结束才释放。  
  事务的结束包括正常结束（COMMIT）和非正常结束（ROLLBACK）。  
  **一级锁协议能防止丢失修改的问题。**

- **二级封锁协议**
  >二级封锁协议是指，在一级封锁协议基础上增加事务T在读取数据R之前必须先对其加S锁，**读完后即可释放S锁**。  
  **二级封锁协议除防止了丢失修改，还可进一步防止读“脏”数据**。  
  在二级封锁协议中，由于读完数据后即可释放S锁，**所以它不能保证可重复读**。

- **三级封锁协议**
  >三级封锁协议是指，在一级封锁协议的基础上增加事务T在读取数据R之前必须先对其加S锁，**直到事务结束才释放**。  
  **三级封锁协议除了防止丢失修改和读“脏”数据外，还进一步防止了不可重复读**。

**三级协议的主要区别在于什么操作需要申请封锁，以及何时释放锁（即持锁时间）**。

## MySQL实现事务的原理

MySQL中事务的实现与其日志文件息息相关。

MySQL的日志文件类型：

- Error log(错误日志)
- Binlog(二进制日志)
- Query log(查询日志)
- Slow query log(慢查询日志)

InnoDB存储引擎两种特有的日志文件：redo log(重做日志)和undo log(回滚日志)。

redo log实现事务的持续性。

undo log是实现事务隔离性和原子性的基础。

MySQL通过锁机制和MVCC（多版本的并发控制协议）实现事务的隔离性。

事务实现原子性、持续性和隔离性，就是为了能实现一致性。即事务的一致性是通过实现持续性、原子性和隔离性来保证的。

## MySQL的隔离级别

待补充——2021/7/26

## 参考资料

- 数据系统概论（第5版） 王珊 萨师煊 编著.
